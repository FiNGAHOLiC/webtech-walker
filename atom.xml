<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Webtech Walker]]></title>
  <link href="http://webtech-walker.com/atom.xml" rel="self"/>
  <link href="http://webtech-walker.com/"/>
  <updated>2012-12-01T08:35:05+09:00</updated>
  <id>http://webtech-walker.com/</id>
  <author>
    <name><![CDATA[Kazuhito Hokamura]]></name>
  </author>

  
  <entry>
    <title type="html"><![CDATA[最近のLessのextendの進捗]]></title>
    <link href="http://webtech-walker.com/archive/2012/12/css_preprocessor_jp.html"/>
    <updated>2012-12-01T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/12/css_preprocessor_jp</id>
    <content type="html"><![CDATA[<p>今年も始まりましたAdvent Calendar。このエントリーは<a href="http://www.adventar.org/calendars/1">CSS Preprocessor Advent Calendar 2012</a>の一日目です。</p>

<p>去年は<a href="http://atnd.org/events/21919">Less &amp; Sass Advent calendar</a>というのをやりましたが、今年はSassやLessだけじゃなく、Stylusなども含めてCSS Preprocessorというくくりにしてみました。まだ最後のほうに空きがあるので我こそはと思われる方はぜひ参加してみてください。</p>

<p>また、Advent Calendarとは関係ないですが、<a href="https://groups.google.com/forum/?hl=ja&amp;fromgroups#!forum/css-preprocessor-jp">CSS Preprocessor JP</a>というグループをつくったので興味がある人はぜひ参加してみてください。Sassのインストールの仕方がわからないとか、最近はどういうのが流行ってるかなど意見交換の場にしてもらえればと思っています。きっとAdvent Calendarの参加者の人たちあたりがビシッと教えてくれるはずです。</p>

<p>さて本題。去年のAdvent Calendarのときに<a href="http://d.hatena.ne.jp/hokaccha/20111214/1323821463">Lessにextendを実装してみた</a>んですが、しばらくとりこまれる気配がなくて、最近になって開発がさかんになり、1_4_0ブランチに取り込まれました。</p>

<p><a href="https://github.com/cloudhead/less.js/tree/1_4_0">cloudhead/less.js at 1_4_0</a></p>

<p>取り込まれてからも<a href="https://github.com/cloudhead/less.js/pull/509">シンタックスに関する議論</a>が活発に続いており、紆余曲折ありましたが、今は以下の様なシンタックスに落ち着いたようです。（が、まだ変わる可能性はあります）</p>

<div class="highlight"><pre><code class="css"><span class="nc">.foo</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.bar</span> <span class="p">{</span>
  <span class="o">&amp;:</span><span class="n">extend</span><span class="p">(</span><span class="o">.</span><span class="n">foo</span><span class="p">);</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>これをコンパイルすると次のようになります。</p>

<div class="highlight"><pre><code class="css"><span class="nc">.foo</span><span class="o">,</span>
<span class="nc">.bar</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.bar</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>最初僕が実装したときは<code>+.foo</code>みたいなシンタックスだったんですが、隣接セレクタみたいでわかりにくいということで<code>++.foo</code>になって、それもやっぱ微妙だねということで<code>&amp;:extend(.foo)</code>のようになったみたいです。</p>

<p>たしかにわかりやすいとは思うけどLessっぽくはないなあと思いつつ、Lessらしさが何なのか語れるほどLessを使ってないので議論には参加してません。</p>

<p>このくらいライトな記事でもいいのでぜひAdvent Calendarに参加してみてください！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[flipsnap.jsでIE10のPointer Eventsに対応した]]></title>
    <link href="http://webtech-walker.com/archive/2012/11/flipsnap_ie10_pointerevents.html"/>
    <updated>2012-11-16T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/11/flipsnap_ie10_pointerevents</id>
    <content type="html"><![CDATA[<p>flipsnap.jsをWindows8のIE10のタッチで動くようにしました。</p>

<p><a href="http://pxgrid.github.com/js-flipsnap/">flipsnap.js</a></p>

<p>思ったより簡単に対応できました。diffはこんな感じ。</p>

<p><a href="https://github.com/pxgrid/js-flipsnap/commit/0524fefdbd8e2b02625a00fada9e2d3f9c73b2ef">IE10 for touch device support. Fix #13 · 0524fef · pxgrid/js-flipsnap</a></p>

<p>IE10はiOSやAndroidのように<code>touchstart</code>や<code>touchmove</code>のようなタッチイベントが用意されておらず、代わりにタッチした際に、pointerイベントというイベントが発火します。</p>

<ul>
  <li><a href="http://www.w3.org/Submission/pointer-events/">Pointer Events Specification</a></li>
  <li><a href="http://blogs.msdn.com/b/ie/archive/2011/09/20/touch-input-for-ie10-and-metro-style-apps.aspx">Touch Input for IE10 and Metro style Apps - IEBlog - Site Home - MSDN Blogs</a></li>
</ul>

<p>まだ<code>MSPointerDown</code>のように<code>MS</code>というprefixがついています。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;MSPointerDown&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// タッチが始まった時の処理</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

<span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;MSPointerMove&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// タッチが動いている時の処理</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

<span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;MSPointerUp&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// タッチが終わった時の処理</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</code></pre>
</div>

<p>基本的にはmouseイベントやtouchイベントと同じように使えるので、イベント名だけ変更すれば対応はできます。また、<code>window.navigator.msPointerEnabled</code>の値を見てpointerイベントが使用可能かどうかを判断することができます。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">support</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">mspointer</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">msPointerEnabled</span><span class="p">,</span>
  <span class="nx">touch</span><span class="o">:</span> <span class="s1">&#39;ontouchstart&#39;</span> <span class="k">in</span> <span class="nb">window</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">touchStartEvent</span> <span class="o">=</span>
    <span class="nx">support</span><span class="p">.</span><span class="nx">mspointer</span> <span class="o">?</span> <span class="s1">&#39;MSPointerDown&#39;</span> <span class="o">:</span>
    <span class="nx">support</span><span class="p">.</span><span class="nx">touch</span> <span class="o">?</span> <span class="s1">&#39;touchstart&#39;</span> <span class="o">:</span>
    <span class="s1">&#39;mousedown&#39;</span><span class="p">;</span>

<span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">touchStartEvent</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// タッチが始まった時の処理</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</code></pre>
</div>

<p>また、1点注意が必要で、CSSで<code>-ms-touch-action: none;</code>というのを指定しないとタッチしたときにネイティブのスクロールなどが優先されてpointerイベントがちゃんと発火しません。JavaScriptからこのプロパティを設定するには次のようにします。</p>

<div class="highlight"><pre><code class="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">support</span><span class="p">.</span><span class="nx">mspointer</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">msTouchAction</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>CSSでやるならこうです。</p>

<div class="highlight"><pre><code class="css"><span class="nf">#element</span> <span class="p">{</span>
  <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="n">touch</span><span class="o">-</span><span class="n">action</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>今回のflipsnap.jsでの対応は将来的にまだpointerイベントがどうなるかわからないので<code>MS</code>のプレフィックス限定で対応しています。将来的にプレフィックスが外れたり他のブラウザでも対応が始まった場合はその都度対応していく予定です。</p>

<p>また、Windows8のタッチ対応端末で確認したところ、Chromeはtouchイベント、Firefoxはmouseイベントが発火していたのでそのままで使えてました。なかなかタッチイベントまわりカオスな状況ですね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advent Calendarの登録サイトつくりました]]></title>
    <link href="http://webtech-walker.com/archive/2012/11/adventar.html"/>
    <updated>2012-11-01T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/11/adventar</id>
    <content type="html"><![CDATA[<p>もうすぐAdvent Calendarの季節なわけですが、いかがお過ごしてしょうか。僕も毎年なんらかのAdvent Calendarに参加したり、去年はSass Less Advent Calendarなどを立てたりしました。</p>

<p>最近はけっこうATNDでAdvent Calendarを募集することが多いみたいなんですが、ATNDは何日に書くことになるのかわかりにくく、順番も決めづらいなどAdvent Calendarの募集には向いてないと個人的には思ってたので、Advent Calendarの登録サイトを作ってみました。</p>

<p><a href="http://www.adventar.org/">Adventar</a></p>

<p>任意の日付にボタン一つで登録できるのでATNDよりは簡単でいいかなと思います。</p>

<p>思いついて特急で作ったんでバグってるところとかつかいにくいとことがあると思いますけどちょいちょい直していく予定です。</p>

<ul>
  <li>エントリー公開後にタイトルとURLを入力できるようにする</li>
  <li>GoogleカレンダーとかiCalでカレンダーの予定を読めるようにする</li>
  <li>デザインとか使い勝手調整</li>
</ul>

<p>などはやろうと思ってます。</p>

<p>ちなみにフレームワークにはRailsを使っていてサーバーには<a href="http://sqale.jp/">Sqale</a>を使ってます。Sqaleはちょうど試してみようと思ってたところにこの前のYAPCで3ヶ月無料クーポンもらったんでラッキーでした。サーバーの設定初めてから1時間くらいでデプロイできたんで超簡単でした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[「ノンプログラマのためのJavaScriptはじめの一歩」の1章が公開されました]]></title>
    <link href="http://webtech-walker.com/archive/2012/10/jsippo_release_intro.html"/>
    <updated>2012-10-31T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/10/jsippo_release_intro</id>
    <content type="html"><![CDATA[<p>11/7発売予定の書籍「<a href="http://www.amazon.co.jp/dp/4774153761">ノンプログラマのためのJavaScriptはじめの一歩</a>」のはじめにと1章が先行して技評のWebサイトで公開されました。</p>

<ul>
  <li><a href="http://gihyo.jp/magazine/wdpress/plus/978-4-7741-5376-6/0001">はじめに</a></li>
  <li><a href="http://gihyo.jp/magazine/wdpress/plus/978-4-7741-5376-6/0002">1章</a></li>
</ul>

<p>1章はイントロ的なところで、JavaScriptを学ぶ前にJavaScriptの動かし方やデバッグツールの使い方について解説しています。</p>

<p>また、本書籍の2章以降で解説するスライドショーのサンプルプログラムも1章で登場するため公開されています。次のようにボタンを押すと次の画像に行くというだけの、簡単なサンプルプログラムです。</p>

<figure>
<iframe src="/sample/2012-10-31-jsippo_release_intro/index.html" width="650" height="550" frameborder="none" style="border: 1px solid #000; background: #FFF; margin: 0 auto;"></iframe>
</figure>

<p><a href="http://image.gihyo.co.jp/assets/files/book/2012/978-4-7741-5376-6/chapter1/1-5-1_slideshow-1/index.html">技評のWebサイト</a>からも実際に試すことができます。</p>

<p>JavaScriptのソースはこんなかんじです。全体で90行程度、コメントや空行を除くと40行程度です。</p>

<div class="highlight"><pre><code class="javascript"><span class="cm">/**</span>
<span class="cm"> * 簡易スライドショー</span>
<span class="cm"> *</span>
<span class="cm"> * nextボタンを押したときに画像を切り替える簡単な</span>
<span class="cm"> * スライドショーのサンプルプログラムです。</span>
<span class="cm"> */</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="cm">/*============================</span>
<span class="cm">     * 変数の定義</span>
<span class="cm">     *===========================*/</span>

    <span class="c1">// 写真のリストの定義</span>
    <span class="kd">var</span> <span class="nx">photoList</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="nx">src</span><span class="o">:</span> <span class="s1">&#39;img/spring.jpg&#39;</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;春の桜&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">src</span><span class="o">:</span> <span class="s1">&#39;img/summer.jpg&#39;</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;夏のひまわり&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">src</span><span class="o">:</span> <span class="s1">&#39;img/autumn.jpg&#39;</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;秋の紅葉&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">src</span><span class="o">:</span> <span class="s1">&#39;img/winter.jpg&#39;</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;冬の山&#39;</span> <span class="p">}</span>
    <span class="p">];</span>
    <span class="kd">var</span> <span class="nx">photoLength</span> <span class="o">=</span> <span class="nx">photoList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="c1">// 要素の取得</span>
    <span class="kd">var</span> <span class="nx">photo</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;photo&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">nextBtn</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;nextBtn&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">);</span>

    <span class="c1">// 現在のインデックスを保存するための変数</span>
    <span class="kd">var</span> <span class="nx">currentIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/*============================</span>
<span class="cm">     * 関数の定義</span>
<span class="cm">     *===========================*/</span>

    <span class="c1">// 指定の写真に表示を切り替える関数</span>
    <span class="kd">function</span> <span class="nx">showPhoto</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 全ての画像を非表示</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">photoLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">photoList</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 表示する対象の要素を取得</span>
        <span class="kd">var</span> <span class="nx">targetPhoto</span> <span class="o">=</span> <span class="nx">photoList</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>

        <span class="c1">// タイトルを表示</span>
        <span class="kd">var</span> <span class="nx">viewNumber</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">title</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">viewNumber</span> <span class="o">+</span> <span class="s1">&#39;] &#39;</span> <span class="o">+</span> <span class="nx">targetPhoto</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>

        <span class="c1">// 画像を表示</span>
        <span class="nx">targetPhoto</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;inline&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*============================</span>
<span class="cm">     * イベントの設定</span>
<span class="cm">     *===========================*/</span>

    <span class="c1">// nextボタンのイベントを設定</span>
    <span class="nx">nextBtn</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 表示するインデックスを計算</span>
        <span class="nx">currentIndex</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">currentIndex</span> <span class="o">===</span> <span class="nx">photoLength</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">currentIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 画像を切り替える</span>
        <span class="nx">showPhoto</span><span class="p">(</span><span class="nx">currentIndex</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/*============================</span>
<span class="cm">     * 初期化処理</span>
<span class="cm">     *===========================*/</span>

    <span class="c1">// img要素をHTMLに追加</span>
    <span class="kd">var</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">img</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">photoLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">item</span> <span class="o">=</span> <span class="nx">photoList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="c1">// img要素を作成</span>
        <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">);</span>

        <span class="c1">// 作成したimg要素に属性を設定</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">src</span><span class="p">;</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">alt</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>

        <span class="c1">// 作成したimg要素をHTMLに追加</span>
        <span class="nx">photo</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">img</span><span class="p">);</span>

        <span class="c1">// 作成したimg要素を保存</span>
        <span class="nx">item</span><span class="p">.</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">img</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 初期表示のためにshowPhotoを一度だけ実行する</span>
    <span class="nx">showPhoto</span><span class="p">(</span><span class="nx">currentIndex</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<p>見る人が見れば突っ込みどころもあるとは思いますが、ひとつのサンプルにループや分岐や関数、イベントやDOM操作など、できるだけ詰め込んで何度もリライトした結果こうなっています。</p>

<p>本書籍ではこのサンプルプログラムを完全に理解することを一つの目標にしています。</p>

<p>2章と3章ではJavaScriptの文法やDOMの基本を解説するのですが、文法や機能を解説するごとに、このプログラムのどこでそれが使われているかを確認し、実際にどのように使われるかを解説したり、どこまでサンプルプログラムを理解できたかを細かく振り返ります。</p>

<p>そして4章ではこのプログラムの流れを解説しながら「読む」ということと、どのようにして一からこのプログラムを「書く」かという二つの視点からプログラムの全体像について解説します。</p>

<p>最後に5章でjQueryについて解説してこのスライドショーをjQueryでも書いてみて、アニメーションなどの機能を付け加えた、より実践的なプログラムにするというのが全体の構成です。</p>

<p>もし1章とサンプルプログラムを見て興味を持った方は購入をご検討ください！</p>

<figure>
  <a href="http://amazon.jp/dp/4774153761">
  <img src="/img/posts/2012-10-23-jsippo/cover.png" alt="ノンプログラマのための JavaScriptはじめの一歩" width="400" height="568" />
  <figcaption>Amazon.co.jp： ノンプログラマのための JavaScriptはじめの一歩</figcaption>
  </a>
</figure>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[lessのextendがexperimentalなブランチにマージされたようです]]></title>
    <link href="http://webtech-walker.com/archive/2012/10/less_extend_experimental.html"/>
    <updated>2012-10-29T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/10/less_extend_experimental</id>
    <content type="html"><![CDATA[<p>一年くらい前に僕がpull requestしたSassのextendみたいな機能をlessにも実装するってやつが実験的なブランチにマージされたっぽい。</p>

<p><a href="https://github.com/cloudhead/less.js/pull/509">Add Sass like extend by hokaccha · Pull Request #509 · cloudhead/less.js</a><br />
<a href="https://github.com/cloudhead/less.js/tree/1_4_0">cloudhead/less.js at 1_4_0</a></p>

<p>シンタックスが<code>+</code>は隣接セレクタと間違えそうだからってことで<code>++</code>になってる。</p>

<p>こんな感じのlessファイルをコンパイルすると</p>

<div class="highlight"><pre><code class="css"><span class="nc">.foo</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.bar</span> <span class="p">{</span>
  <span class="o">++.</span><span class="n">foo</span><span class="p">;</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>結果はこうなる。</p>

<div class="highlight"><pre><code class="css"><span class="nc">.foo</span><span class="o">,</span>
<span class="nc">.bar</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.bar</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>npmはgithubからモジュールをインストールできて<code>#</code>以降にブランチ名を指定すれば特定のブランチのものを取ってくるので次のようにすれば試すことができる。</p>

<pre><code>$ cd path/to/working_dir
$ npm install git://github.com/cloudhead/less.js.git#1_4_0
$ ./node_modules/.bin/lessc test.less
.foo,
.bar {
  color: red;
}
.bar {
  font-size: 13px;
}
</code></pre>

<p>lessの作者のcloudheadさんがやる気なくしたのかなんなのか、まったくコミットしなくなってlessはもう終わりだみたいな感じに一時期なっていて、extendのやつも全く取り込まれる気配がなかったんだけど、最近では別の人が開発を引き継いで開発が進んでるようで、extendもそういう流れで取り込まれたみたい。</p>

<p>masterにいつマージされるか（そもそもマージされるかどうか）はまだ未定だけど早く使えるようになるといいな。</p>

<p>ちなみにそんな僕は最近Sass派。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mochaとphantomJSとtravis-ciでフロントエンドJavaScriptのテスト]]></title>
    <link href="http://webtech-walker.com/archive/2012/10/mocha_phantomjs_travisci.html"/>
    <updated>2012-10-23T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/10/mocha_phantomjs_travisci</id>
    <content type="html"><![CDATA[<p><a href="http://atnd.org/events/33022">東京Node学園祭2012 アドベントカレンダー</a>の9日目です。Node.jsとほとんど関係ないうえに内容がけっこう薄い感じなった気がするんですけど気にせずいこうと思います。</p>

<p>フロントエンドのJavaScriptをテストするとき最近はいつもmochaを使ってるんですが、やはりJenkinsとかtravis-ciを使って自動テストもしたいと思って試してみました。</p>

<p><a href="https://github.com/hokaccha/mocha-phantom-travis-test">hokaccha/mocha-phantom-travis-test</a></p>

<p>ここではよくあるjQueryで画像のロールオーバーをするというプラグインを作ってそのライブラリに対してテストを書いています。ソースコードはこんな感じです。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">rollover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$img</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">src_on</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_off\.(\w+)$/</span><span class="p">,</span> <span class="s1">&#39;_on.$1&#39;</span><span class="p">);</span>

    <span class="nx">$img</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;mouseenter&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nx">src_on</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">$img</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;mouseleave&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nx">src</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre>
</div>

<p>画像名に<code>_off</code>という文字列がある場合にマウスオーバーで<code>_on</code>に切り替えるといういたって普通のロールオーバーのプラグインです。こんな感じで動きます。</p>

<p><a href="http://hokaccha.github.com/mocha-phantom-travis-test/example/">rollover sample</a></p>

<p>このプラグインに対してmochaでテストを書くとこのようになります。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;jquery.rollover&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">$img</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">off</span> <span class="o">=</span> <span class="s1">&#39;../example/menu01_off.png&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="s1">&#39;../example/menu01_on.png&#39;</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$img</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;img&gt;&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nx">off</span><span class="p">).</span><span class="nx">rollover</span><span class="p">();</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">(</span><span class="nx">off</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;mouseenterで_offが_onになること&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$img</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;mouseenter&#39;</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">(</span><span class="nx">on</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;mouseleaveで_onが_offになること&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$img</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;mouseenter&#39;</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">(</span><span class="nx">on</span><span class="p">);</span>

    <span class="nx">$img</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;mouseleave&#39;</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">(</span><span class="nx">off</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>ブラウザでテストを実行するとこんな感じになります。</p>

<p><a href="http://hokaccha.github.com/mocha-phantom-travis-test/test/">Test | jquery.rollover</a></p>

<p>このテストをphantomJSで実行できるようにします。mochaのテストをphantomJSで実行できるようにするのに<a href="https://github.com/metaskills/mocha-phantomjs">mocha-phantomjs</a>というのものがあります。mochaはreporterにspecやtapを指定してブラウザで実行した場合<code>console.log</code>で出力するのでphantomJSの<code>onConsoleMessage</code>とか使えば簡単に書けそうだったので自分で書いてみようと思ったんですけど予想以上に面倒なことが多かったのでおとなしくこのライブラリをつかうことにしました。</p>

<p>mocha-phantomjsをnpmでインストールするようにしてもいいんですが、フロントエンドのコードしかないプロジェクトにnodeとかnpmの依存が入るのはどうかと思ったので必要なファイルだけもってきて設置しました。必要なのは以下の2ファイルです。</p>

<ul>
  <li><a href="https://github.com/metaskills/mocha-phantomjs/blob/master/lib/mocha-phantomjs.coffee">lib/mocha-phantomjs.coffee</a></li>
  <li><a href="https://github.com/metaskills/mocha-phantomjs/blob/master/lib/mocha-phantomjs/core_extensions.js">lib/mocha-phantomjs/core_extensions.js</a></li>
</ul>

<p>どこに置いてもいいんですが、今回の例ではtest/libディレクトリに設置しています。</p>

<p><a href="https://github.com/hokaccha/mocha-phantom-travis-test/tree/master/test/lib">mocha-phantom-travis-test/test/lib</a></p>

<p>そして<code>mocha.run()</code>を実行するところを次のように書きます。</p>

<div class="highlight"><pre><code class="javascript"><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">mochaPhantomJS</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mochaPhantomJS</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">mocha</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

<p>phantomJSから呼ぶ場合は<code>mochaPhantomJS.run()</code>で実行、そうでない場合は通常の<code>mocha.run()</code>でテストを実行するようにしています。</p>

<p>これで以下のようにするとmochaのテストをコマンドラインから実行できます。</p>

<pre><code>$ phantomjs test/lib/mocha-phantomjs.coffee test/index.html

  jquery.rollover
    ✓ mouseenterで_offが_onになること 
    ✓ mouseleaveで_onが_offになること 


  ✔ 2 tests complete (21 ms)
</code></pre>

<p>ファイル名の後にreporterを指定することもできるので結果を<code>tap</code>で出力することもできます。デフォルトは<code>spec</code>です。</p>

<p>最後にtravis-ciの設定ですが、travis-ciはphantomJSをサポートしているので、.travis.ymlにその設定を以下のように書くだけです。</p>

<pre><code>script: phantomjs test/lib/mocha-phantomjs.coffee test/index.html
</code></pre>

<p>これでtravis-ciのほうでこのリポジトリを追加してpushしたら自動でテストが走るようになります。簡単すぎワロタ。</p>

<p>以下が結果です。</p>

<p><a href="https://travis-ci.org/#!/hokaccha/mocha-phantom-travis-test/builds/2862206">hokaccha/mocha-phantom-travis-test #1 | Travis CI</a></p>

<p>以下はわざとコケるようにしてみたテストの結果です。</p>

<p><a href="https://travis-ci.org/#!/hokaccha/mocha-phantom-travis-test/builds/2862214">hokaccha/mocha-phantom-travis-test #2 | Travis CI</a></p>

<p>このようにtravis-ciを使うと簡単に自動テストできますが、phantomJSでテストできるところまでいけばあとはJenkinsでも同じようにできるはずです。</p>

<p>便利な世の中になったものだと思いました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[「ノンプログラマのための JavaScriptはじめの一歩」という本を書きました]]></title>
    <link href="http://webtech-walker.com/archive/2012/10/jsippo.html"/>
    <updated>2012-10-23T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/10/jsippo</id>
    <content type="html"><![CDATA[<figure>
  <a href="http://amazon.jp/dp/4774153761">
  <img src="/img/posts/2012-10-23-jsippo/cover.png" alt="ノンプログラマのための JavaScriptはじめの一歩" width="400" height="568" />
  <figcaption>Amazon.co.jp： ノンプログラマのための JavaScriptはじめの一歩</figcaption>
  </a>
</figure>

<p>2012/11/7に発売予定です。ハッシュタグは<a href="https://twitter.com/search/realtime?q=%23jsippo">#jsippo</a>なのでみなさんどうぞふるってツイートしてください。</p>

<h2 id="section">想定している対象</h2>

<p>タイトルからもわかるように、デザイナやマークアップエンジニアなどをやっていてプログラムはほとんどわからないというくらいの読者を想定しています。</p>

<p>なので普段JavaScriptを書いている人や、他の言語をやっていて、JavaScriptを学んでみようと思っているような方にはもの足りない内容だと思います。そういう人は<a href="http://www.amazon.co.jp/gp/product/4873115736?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=4873115736&amp;linkCode=shr&amp;tag=webtech00-22">サイ本</a>とか<a href="http://www.amazon.co.jp/gp/product/477414813X?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=477414813X&amp;linkCode=shr&amp;tag=webtech00-22&amp;=books&amp;qid=1350202385&amp;sr=1-1">パーフェクトJavaScript</a>を読みましょう。</p>

<p>何を書いて何を書かないかというところの線引に苦労しました。たとえば変数のスコープやprototypeなどはJavaScriptを学ぶ上では避けて通れませんが、そこは敢えて説明を省いています。初めてプログラムを学ぶときにスコープがどうとか言われてもわからないので、そこを学ぶのは二歩目、三歩目からで十分だと思ったからです。でもこれを説明しないとアレが説明できないし・・みたいな葛藤もけっこうありました。</p>

<h2 id="section-1">特徴</h2>

<p>この書籍でおそらく一番特徴的なのは一つのサンプルプログラムを、一冊を通して解説するということです。そのプログラムは簡単なものでボタンを押すと予め用意しといた数枚の画像が切り替わる、簡易的なスライドショーのプログラムです。</p>

<p>なぜこのような構成にしたかというと、ある機能を解説したとき、実際のプログラムでどのようにそれが使われるかがわかると、より深く理解ができると思ったからです。</p>

<p>例えば「配列」というものを学んだ時に、配列がどういうものかなんとなくわかっても、それを使うと何がいいのか、実際のプログラムではどのように利用すればいいのかというところまで理解してほしいと思いました。なので、「配列」というものの解説をした後、実際にスライドショーのどこでどのように使われているかを解説しています。</p>

<p>初学者向けなので、配列をつくるときに「どう書くか」はもちろん解説しますが、「どう使うか」というのをできるだけ感じてもらう配慮をしたつもりです。</p>

<p>これまでこのような構成の本は見たことがないので（知らないだけかもしれないけど）、もしかしたら逆にわかりにくくなっているのではないかという不安もありますが、他にあまりない構成にできたし、うまくまとめられたと思うのでよかったと思っています。</p>

<p>スライドショーのプログラムはjQueryを使わず書いていますが、実務で使うときにjQueryは避けて通れないので最後にjQueryについて解説し、スライドショーのプログラムをjQueryで書きなおしてブラッシュアップするという構成になっています。</p>

<h2 id="section-2">イベント告知</h2>

<p>出版記念イベントとしてジュンク堂さんで<a href="http://twitter.com/takazudo">@takazudo</a>さんと「ノンプログラマがJavaScriptを 学んでいくにはどうすればいいのか」というテーマでトークセッションします。興味があるかたはぜひご参加ください。</p>

<p><a href="http://www.junkudo.co.jp/tenpo/evtalk.html#20121122_talk">http://www.junkudo.co.jp/tenpo/evtalk.html#20121122_talk</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[gitで差分ファイルを抽出する]]></title>
    <link href="http://webtech-walker.com/archive/2012/09/git_export_diff.html"/>
    <updated>2012-09-24T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/09/git_export_diff</id>
    <content type="html"><![CDATA[<p>変更したファイルだけまとめて取り出したいというケースがけっこうあるみたいなんで書いてみた。</p>

<p><a href="https://gist.github.com/3764870">gitの差分のファイルをつくる — Gist</a></p>

<p>こいつをパスが通ってるところに置いて実行権限つけたら</p>

<pre><code>$ git export-diff &lt;commit&gt; &lt;output_dir&gt;
</code></pre>

<p>こんな感じで実行すると<code>&lt;commit&gt;</code>からHEADまでの差分ファイルを<code>&lt;output_dir&gt;</code>にコピーする。<code>&lt;commit&gt;</code>の部分は<code>git diff</code>と同じ物が使えるので</p>

<pre><code>$ git export-diff HEAD^^^ path/to/dir
$ git export-diff HEAD^^^..HEAD^ path/to/dir
$ git export-diff &lt;sha1&gt; &lt;sha1&gt; path/to/dir
$ git export-diff &lt;sha1&gt;..&lt;sha1&gt; path/to/dir
</code></pre>

<p>みたいな感じでもOK。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jQueryでアニメーション終了時のcallback]]></title>
    <link href="http://webtech-walker.com/archive/2012/09/jquery_animate_callback.html"/>
    <updated>2012-09-23T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/09/jquery_animate_callback</id>
    <content type="html"><![CDATA[<p>jQueryでfadeOutとかのアニメーションして終わったらなんかするといったときにcallback関数を引数に指定するのとDeferred使う方法があるんだけどこの二つは挙動が違う。</p>

<p>こういうHTMLがあったとして</p>

<div class="highlight"><pre><code class="html"><span class="nt">&lt;div&gt;</span>foo<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>bar<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>baz<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>まず以下のようなcallback関数の場合はそれぞれのfadeOutが終わるごとに呼ばれる。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fin&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>つまり<code>'fin'</code>が3回出力される。</p>

<p>一方Deferredを使った場合はこんな感じ。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">.</span><span class="nx">promise</span><span class="p">().</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fin&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p><code>.promise()</code>がDeferredオブジェクトを返すので<code>.done</code>に設定した関数がアニメーション終了時に呼ばれる。こっちは全てのアニメーションが終わった時点で呼ばれるので<code>'fin'</code>は一回しか呼ばれない。という違いがあるみたい。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HerokuでResqueを使うときに優雅に再起動する]]></title>
    <link href="http://webtech-walker.com/archive/2012/09/resque_heroku.html"/>
    <updated>2012-09-21T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/09/resque_heroku</id>
    <content type="html"><![CDATA[<p>Ruby製のジョブキューサーバーである<a href="https://github.com/defunkt/resque">Resque</a>はHerokuのWorkerプロセスで動かそうとすると一つ問題があった。</p>

<p>シグナルハンドリングの問題なんだけど、Herokuはworkerプロセスを再起動するときに<code>SIGTERM</code>を送り、プロセスが終了したら再度プロセスを起動する。<code>SIGTERM</code>を送ってworkerが10秒間プロセスが終了しなかったら<code>SIGKILL</code>で強制終了させる。のでworker側は<code>SIGTERM</code>を受け取ったら10秒以内に安全に（今あるジョブを終了するなりなんなりして）プロセスを終了する必要がある。</p>

<p>そのようなHerokuの挙動は以下に書いてある。</p>

<p><a href="https://devcenter.heroku.com/articles/ps#graceful-shutdown-with-sigterm">Managing Heroku Processes | Heroku Dev Center</a></p>

<p>一方で、Resqueのシグナルハンドリングがどうなっているかというと、<code>SIGTERM</code>で強制終了するようになってる。</p>

<p><a href="https://github.com/defunkt/resque/blob/1-x-stable/README.markdown#signals">resque/README.markdown at 1-x-stable · defunkt/resque</a></p>

<p>なのでHerokuでResqueを使った場合、再起動するときに安全にプロセスが再起動できないという問題があったというわけ。</p>

<p>なのでこんな感じのforkしてシグナルハンドリングの部分だけパッチ当てたやつとかもあった。</p>

<p><a href="https://github.com/mjezzi/resque-cedar">mjezzi/resque-cedar · GitHub</a></p>

<p>で、それがResqueの1.22.0で解決されたみたい。</p>

<p>1.22.0では<code>TERM_CHILD=1</code>というのを環境変数で設定すればマスタプロセスが<code>SIGTERM</code>を受け取ったときに、起動している子プロセスに対して<code>SIGTERM</code>を送り、子プロセスが<code>RESQUE_TERM_TIMEOUT</code>で設定された秒数の間に終了しなかったら子プロセスに<code>SIGKILL</code>を送って強制終了させるという機能が実装された。これによって</p>

<pre><code>$ TERM_CHILD=1 RESQUE_TERM_TIMEOUT=10 QUEUES=* rake resque:work
</code></pre>

<p>のように起動し、worker側で<code>SIGTERM</code>をハンドリングすることで安全に再起動できるようになる。</p>

<h2 id="section">試してみる</h2>

<div class="highlight"><pre><code class="ruby"><span class="c1"># worker.rb</span>

<span class="nb">require</span> <span class="s1">&#39;resque/errors&#39;</span>

<span class="k">class</span> <span class="nc">SampleWork</span>
  <span class="vi">@queue</span> <span class="o">=</span> <span class="ss">:test</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span>
    <span class="nb">sleep</span> <span class="mi">10</span>
    <span class="nb">puts</span> <span class="s1">&#39;complete job!&#39;</span>
  <span class="k">rescue</span> <span class="no">Resque</span><span class="o">::</span><span class="no">TermException</span>
    <span class="nb">sleep</span> <span class="mi">2</span>
    <span class="nb">puts</span> <span class="s1">&#39;graceful shutdown!&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<div class="highlight"><pre><code class="ruby"><span class="c1"># clinet.rb</span>

<span class="nb">require</span> <span class="s1">&#39;resque&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;./worker&#39;</span>

<span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span> <span class="no">SampleWork</span>
</code></pre>
</div>

<div class="highlight"><pre><code class="ruby"><span class="c1"># Rakefile</span>

<span class="nb">require</span> <span class="s1">&#39;resque/tasks&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;./worker&#39;</span>
</code></pre>
</div>

<p>こんな感じのworkerをつくって試してみる。<code>Resque::TermException</code>という例外でResqueからの<code>SIGTERM</code>をキャッチできるようなのでこのworkerは<code>SIGTERM</code>を受け取ったら2秒待って文字列を出力した後終了することが期待される。</p>

<p>まずは普通にworkerを起動してみる。</p>

<pre><code>$ QUEUES=* rake resque:work                       
</code></pre>

<p>この状態でclinet.rbでジョブを登録して10秒以内にResqueのマスタプロセスに対して<code>SIGTERM</code>を送る。</p>

<pre><code>$ kill -TERM {pid}
</code></pre>

<p>そしたら起動していたワーカープロセスは何も出力されずに終了した。これは<code>SIGTERM</code>を受け取ったら強制終了というResqueのドキュメントに書いてある挙動なので正しい。</p>

<p>次に<code>TERM_CHILD</code>と<code>RESQUE_TERM_TIMEOUT</code>を指定して起動してみる。</p>

<pre><code>$ TERM_CHILD=1 RESQUE_TERM_TIMEOUT=10 QUEUES=* rake resque:work
</code></pre>

<p>同じようにclinet.rbでジョブを登録して10秒以内にResqueのマスタプロセスに対して<code>SIGTERM</code>を送る。そうすると2秒後に</p>

<pre><code>$ TERM_CHILD=1 RESQUE_TERM_TIMEOUT=10 QUEUES=* rake resque:work
graceful shutdown!
</code></pre>

<p>となってプロセスが終了して期待通り動いた。</p>

<p>次に<code>RESQUE_TERM_TIMEOUT=1</code>としてタイムアウトを1秒に指定する。</p>

<pre><code>$ TERM_CHILD=1 RESQUE_TERM_TIMEOUT=1 QUEUES=* rake resque:work
</code></pre>

<p>これで同じようにジョブを登録して<code>SIGTERM</code>を送ったら何も出力されずに終了した。sleepが2秒でタイムアウトが1秒なので<code>SIGTERM</code>のハンドリングで終了するより先にタイムアウトして終了したことがわかる。</p>

<p>Resque 2.xではこれがデフォルトになるとかなんとか（要確認）。</p>

<h3 id="section-1">参考</h3>

<ul>
  <li><a href="https://devcenter.heroku.com/articles/queuing-ruby-resque">Queuing in Ruby with Redis and Resque | Heroku Dev Center</a></li>
  <li><a href="http://hone.heroku.com/resque/2012/08/21/resque-signals.html">hone.heroku.com | Resque Signals</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[俺の最強ブログシステムも火を噴いてたぜ]]></title>
    <link href="http://webtech-walker.com/archive/2012/09/fired-myblog.html"/>
    <updated>2012-09-20T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/09/fired-myblog</id>
    <content type="html"><![CDATA[<p><a href="http://tech.nitoyon.com/ja/blog/2012/09/20/moved-completed/">俺の最強ブログ システムが火を噴くぜ - てっく煮ブログ</a></p>

<p>これとJekyll、DISQUS、Githubを使ってるところあたりはほとんど同じだった。</p>

<p>元記事がレンタルサーバーにデプロイしてるのに対してこっちはgithub pagesにデプロイしてる。サーバーも用意しなくていいからお手軽かつ最強だぜ〜。</p>

<p>ただgithub pagesに直接Jekyllのソース上げるとplugin使えなかったりして不便なんでJekyllで生成した静的ファイルをgh-pagesブランチにコミットしていて</p>

<ul>
  <li><a href="https://github.com/hokaccha/webtech-walker">masterブランチ</a> -&gt; ソース</li>
  <li><a href="https://github.com/hokaccha/webtech-walker/tree/gh-pages">gh-pagesブランチ</a> -&gt; 生成したファイル</li>
</ul>

<p>ってしてるんだけど、いちいちブランチ切り替えてなんちゃらしたりhookスクリプトでほげほげするのは面倒なんで</p>

<pre><code>$ rake deploy
</code></pre>

<p>ってやるとJekyllのビルドが走って生成したファイルコピーしてgh-pagesにコミットしてGithubにpushするところまで自動でできるようにしてる。ビルドタスクはこんな感じ。</p>

<p><a href="https://github.com/hokaccha/webtech-walker/blob/f2b178baa3bb00776f089f50b7b3e2954c83694c/Rakefile#L10-20">webtech-walker/Rakefile at f2b178baa3bb00776f089f50b7b3e2954c83694c · hokaccha/webtech-walker</a></p>

<div class="highlight"><pre><code class="ruby"><span class="n">desc</span> <span class="s1">&#39;deploy to production&#39;</span>
<span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">sh</span> <span class="s1">&#39;bundle exec jekyll&#39;</span>
  <span class="n">sh</span> <span class="s1">&#39;rm -rf _deploy/*&#39;</span>
  <span class="n">sh</span> <span class="s1">&#39;cp -R _site/* _deploy&#39;</span>
  <span class="n">cd</span> <span class="s1">&#39;_deploy&#39;</span> <span class="k">do</span>
    <span class="n">sh</span> <span class="s1">&#39;git add -A&#39;</span>
    <span class="n">sh</span> <span class="s1">&#39;git commit -v&#39;</span>
    <span class="n">sh</span> <span class="s1">&#39;git push origin gh-pages&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>あとキャッシュ系のプラグインは使ってなくて、新しい記事書くときは</p>

<pre><code>$ jekyll --auto --server --limit_posts 3
</code></pre>

<p>とかすれば対象の記事を絞れるので遅くならないし、デプロイのときは全記事出力するからちょっと遅いけど今160記事くらいで5秒程度だからまあ別に大丈夫かなと思ってる。でもコードハイライト多用してる場合はこういう問題もあるから注意。</p>

<p><a href="http://d.hatena.ne.jp/hokaccha/20120808/1344436656">pygmentsが原因でjekyllが重くなってた - hokaccha.hamalog v2</a></p>

<p>というわけでJekyllおすすめ。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jQueryのイベントハンドラでreturn falseするとイベントのバブリングが止まる]]></title>
    <link href="http://webtech-walker.com/archive/2012/09/event_handler_return_false.html"/>
    <updated>2012-09-20T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/09/event_handler_return_false</id>
    <content type="html"><![CDATA[<p>例えばjQueryでスムーズスクロール的なのを実装したとして、a要素のデフォルトの機能を止めるために以下のように<code>return false</code>ってするとイベントのバブリングまでとまるよという話。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a[href*=#]&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// スムーズスクロースの処理</span>
    <span class="p">...</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>つまり</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a[href*=#]&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>

    <span class="c1">// スムーズスクロースの処理</span>
    <span class="p">...</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>としたときと同じ挙動になる。<code>return false</code>してるコードは、デフォルトの挙動を止めるのは意図してるけど、イベントのバブリングまで止めるのは意図してない場合が多いんじゃなかろうかと思う。意図してるなら特に問題ない。</p>

<p>それでイベントのバブリングがとまると何が一番困るかというdelegateが使えなくなること。</p>

<p>具体的にはこれが動かない。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a[href*=#]&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// スムーズスクロースの処理</span>
    <span class="p">...</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">delegate</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;clicked!!&#39;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>delegateはイベントのバブリングを利用してイベントを捕まえるので最初のスムーズスクロールで<code>return false</code>しちゃうとそこでイベントのバブリングが止まるのでdelegateのイベントが実行されない。なのでイベントのデフォルトの動作を止めたいだけなら、できるだけ</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a[href*=#]&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="c1">// スムーズスクロースの処理</span>
    <span class="p">...</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>のように<code>preventDefault()</code>を使うようにしたほうがいいよねというお話でした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JavaScriptのゲッタ]]></title>
    <link href="http://webtech-walker.com/archive/2012/09/jsgetter.html"/>
    <updated>2012-09-07T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/09/jsgetter</id>
    <content type="html"><![CDATA[<p>JavaScriptでゲッタを定義するのに__defineGetter__っていうのが使えて</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">obj</span><span class="p">.</span><span class="nx">__defineGetter__</span><span class="p">(</span><span class="s1">&#39;hoge&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hoge!!&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">obj</span><span class="p">.</span><span class="nx">hoge</span><span class="p">;</span> <span class="c1">//=&gt; hoge!!</span>
</code></pre>
</div>

<p>こんな感じで()つけなくても関数が呼び出されるのでプロパティにアクセスのようにして関数を呼び出すことができる。</p>

<p>Node.jsのライブラリのコード読んでるとよく__defineGetter__がでてくる（Node.jsのコードというかTJのコードに多いだけな気もする）。</p>

<p><a href="https://github.com/visionmedia/express/blob/75fc8820016739a38b395955902ce118467c8f42/lib/request.js#L180">express/lib/request.js at master · visionmedia/express · GitHub</a></p>

<p>でも__defineGetter__はECMAScript非標準なんで非推奨ってMDNに書いてある。</p>

<p><a href="https://developer.mozilla.org/ja/docs/JavaScript/Reference/Global_Objects/Object/defineGetter">defineGetter | MDN</a></p>

<p>Object.definePropertyを使えって書いてある。Object.definePropertyを使うとこんな感じ。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="s1">&#39;hoge&#39;</span><span class="p">,</span> <span class="p">{</span>  
  <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hoge!!&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">obj</span><span class="p">.</span><span class="nx">hoge</span><span class="p">;</span> <span class="c1">//=&gt; hoge!!</span>
</code></pre>
</div>

<p>もしくはこれでもいける。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">get</span> <span class="nx">hoge</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hoge!!&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">obj</span><span class="p">.</span><span class="nx">hoge</span><span class="p">;</span> <span class="c1">//=&gt; hoge!!</span>
</code></pre>
</div>

<p>どれが一番いいかはよくわからん。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[github pages + jekyllにした]]></title>
    <link href="http://webtech-walker.com/archive/2012/08/renewal.html"/>
    <updated>2012-08-08T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2012/08/renewal</id>
    <content type="html"><![CDATA[<p>5年くらい前のWordPressで動いてたブログをjekyllにしてgithub pagesで動くように移行しました。ついでにデザインもリニューアル。</p>

<p>エントリーのURLは変わってないんだけど、フィードのURLだけ変わりました。というか、feedburner.jpのドメインでフィード配信してたんですけど、feedburner.jpがちょっと前に使えなくなったみたいで、変えないといけなくなりました。新しいのはこれ。</p>

<p><a href="http://webtech-walker.com/atom.xml">Feed</a></p>

<p>github pagesとjekyllにしてgitでデプロイできるのとMarkdownで記事書けるようにったのはすごくいいんだけど、問題は記事数が多くて（160記事くらい）jekyllの実行に20秒くらいかかること。なんか一周してMTの再構築問題に戻ってきた気分。</p>

<p><ins>
追記：jekyllの実行に時間がかかるの解決した。こっちに書いた。
</ins></p>

<p><a href="http://d.hatena.ne.jp/hokaccha/20120808/1344436656">pygmentsが原因でjekyllが重くなってた - hokaccha.hamalog v2</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Firefox5でCSSの@keyframesにクオートがあると動かない件について]]></title>
    <link href="http://webtech-walker.com/archive/2011/06/24154503.html"/>
    <updated>2011-06-24T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2011/06/24154503</id>
    <content type="html"><![CDATA[<p>Firefox5でCSSのAnimationsが実装されましたが、ちょっとWebkit系と違うところがあるみたいです。</p>

<p>どう違うかというと、@keyframesのアニメーション名にクオートを付けるとWebkit系は動くけどFirefox5は動かないみたい。</p>

<p><a href="/sample/2011-06-24-24154503/index.html">DEMO</a></p>

<p>つまりこういうこと。（説明簡略化のためベンダプレフィックスは除いてます）</p>

<div class="highlight"><pre><code class="css"><span class="c">/* Webkitは動くけどFirefoxは動かない */</span>
<span class="k">@keyframas</span> <span class="s1">&#39;hoge&#39;</span> <span class="p">{</span>
    <span class="c">/* ... */</span>
<span class="p">}</span>

<span class="c">/* WebkitでもFirefoxでも動く */</span>
<span class="k">@keyframas</span> <span class="nt">hoge</span> <span class="p">{</span>
    <span class="c">/* ... */</span>
<span class="p">}</span>
</code></pre>
</div>

<p>で、仕様はどうなってるか見てみると</p>

<p><a href="http://www.w3.org/TR/css3-animations/">CSS Animations Module Level 3</a></p>

<blockquote>
  <p>keyframes-rule: ‘@keyframes’ IDENT ‘{’ keyframes-blocks ‘}’;</p>
</blockquote>

<p>って書いてあります。で、IDENTってところにキーフレーム名がくるわけですが、このIDENTってのが何かというは別の仕様に書いてあって</p>

<p><a href="http://www.w3.org/TR/CSS21/syndata.html">Syntax and basic data types</a></p>

<p>ここで定義されてるんですけど、IDENTはどうもクオートがつかない文字っぽいんですよね。なのでFirefoxでクオートがあると動かないのは仕様通りな気がします。ちなみにAnimationsの仕様書のExampleのコードはクオートありになってるんですが、これはExampleのコードが間違えなのかな。。？</p>

<p>さらに、Safariのドキュメント見てみると</p>

<p><a href="http://developer.apple.com/library/safari/#documentation/appleapplications/reference/SafariCSSRef/Articles/OtherStandardCSS3Features.html">Safari CSS Reference: Supported CSS Rules</a></p>

<blockquote>
  <p>keyframes-rule: ‘@-webkit-keyframes’ [ IDENT | STRING ] ‘{’ keyframes-blocks ‘}’;</p>
</blockquote>

<p>って書いてあって、W3Cのほうの仕様書と違ってSTRINGが追加されてます。STRINGはクオートで囲む文字列のようなので、これに従うとWebkitのほうが正しいわけです。</p>

<p>まあまだ全然仕様が固まってない状態なのでこういうのもしょうがないんでしょうか。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[dotcloud + node.jsでHello World]]></title>
    <link href="http://webtech-walker.com/archive/2011/06/13082522.html"/>
    <updated>2011-06-13T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2011/06/13082522</id>
    <content type="html"><![CDATA[<p>dotcloud + node.jsやってみました。</p>

<p>まずdotcloudをインストールする。特に問題ない。</p>

<pre><code>$ sudo easy_install dotcloud
</code></pre>

<p>アプリケーションをつくる。APIキーを設定してない場合は設定しろと出るので指示通りsettingsページに書いてあるAPIキーを入力する。</p>

<pre><code>$ dotcloud create hokaccha
Warning: /Users/hokamura/.dotcloud/dotcloud.conf does not exist.
Enter your api key (You can find it at http://www.dotcloud.com/account/settings):
</code></pre>

<p>プロジェクトを作る。</p>

<pre><code>$ dotcloud deploy -t nodejs hokaccha.helloworld
Created "hokaccha.helloworld".
</code></pre>

<p>最低限必要なのはsupervisord.confという設定ファイル。ここで起動用のスクリプトを指定する。supervisord.confの中身はこんな感じ。</p>

<pre><code>[program:node]
command = node server.js
directory = /home/dotcloud/current
</code></pre>

<p>同じディレクトリに指定したserver.jsを置いてHello Worldの出力するサーバーを書く。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span> <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;Hello World!!&#39;</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
</code></pre>
</div>

<p>これでこの二つのファイルを置いたディレクトリを指定してアップする。</p>

<pre><code>$ dotcloud push hokaccha.helloworld .
</code></pre>

<p>これだけだった。10分くらいでできて超簡単。</p>

<p><a href="http://helloworld.hokaccha.dotcloud.com/">http://helloworld.hokaccha.dotcloud.com/</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[続・iOSのSafariで特定のfont-sizeのときの謎の隙間]]></title>
    <link href="http://webtech-walker.com/archive/2011/06/03104808.html"/>
    <updated>2011-06-03T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2011/06/03104808</id>
    <content type="html"><![CDATA[<p><a href="/archive/2011/03/30190850.html">前書いたiOSのSafariで幅計算がおかしくなる件</a>、もうちょい調査してみた。</p>

<p>どうもfont-sizeが11px、10px、9pxのときにマルチバイト一文字につき、offsetWidthの値がそれぞれ1pxづつ大きい値になるというバグっぽい。</p>

<p>「あ」の文字のspan要素のoffsetWidthをJSで取得するデモ。</p>

<p><a href="/sample/2011-06-03-03104808/1.html">DEMO</a></p>

<p>これiPhoneで見るとこうなる。</p>

<p><img src="/img/posts/2011-06-03-03104808/ios_fontsize_width.png" alt="11px, 10px, 9pxのoffsetWidthがずれている" /></p>

<p>なんかIEでもfont-sizeが11px指定のときに12pxで表示されるというバグがあった気がするけど、このバグはさらに凶悪で、フォントサイズは指定したサイズになるけどoffsetWidthだけ指定のサイズより大きくなるというもの。それであのようなずれが生じるみたいです。</p>

<p>JSでoffsetWidthの値の変化がとれるということはバグがあるかどうか判定できそうだということでやってみた。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">mbFontsizeWidthCalcBug</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

    <span class="nx">span</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span>
    <span class="nx">span</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
    <span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;あ&#39;</span><span class="p">;</span>
    <span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">span</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(;</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">span</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">fontSize</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
        <span class="nx">width</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">span</span><span class="p">);</span>
    <span class="nx">body</span> <span class="o">=</span> <span class="nx">span</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">width</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">===</span> <span class="nx">width</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">width</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">===</span> <span class="nx">width</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
<span class="p">})(</span><span class="nb">document</span><span class="p">);</span>
</code></pre>
</div>

<p><a href="/sample/2011-06-03-03104808/2.html">DEMO</a></p>

<p>とりあえず判定はできるっぽい。これでModernizrみたいにhtml要素とかにclassつければなんとかCSSで分岐できそうではある。が、うーん。。。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AndroidでJavaScriptのconsole.logを表示する方法]]></title>
    <link href="http://webtech-walker.com/archive/2011/05/12152024.html"/>
    <updated>2011-05-12T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2011/05/12152024</id>
    <content type="html"><![CDATA[<p>Androidでconsole.logとかの出力を見るのには二通りあるみたいです。</p>

<ol>
  <li>
    <h2 id="aboutdebug">about:debug</h2>
  </li>
</ol>

<p>ブラウザのアドレスバーにabout:debugと打ち込むとJavaScriptのコンソールが現れます。これ簡単でいいんですけど、実機（Xperia ack）で試したらなんかよく（OSごと）落ちるし、いちいち入力するの面倒だしでちょっと微妙でした。あとどのバージョンからこれに対応してるかもよく知らない。</p>

<p><img src="/img/posts/2011-05-12-12152024/1.png" alt="Androidのブラウザのアドレスバーにabout:debugと入力" /></p>

<p><img src="/img/posts/2011-05-12-12152024/2.png" alt="console.logが出力される" /></p>

<ol>
  <li>
    <h2 id="adb-logcat">adb logcat</h2>
  </li>
</ol>

<p>たぶんこっちが正当法。AndroidSDKに入ってるadb（Android Debug Bridge）というツールを使います。adbはAndroidSDKの tools/adb にあります。</p>

<p>まずエミュレータの場合。エミュレータを立ち上げたら以下のコマンドで接続を確認します。</p>

<pre><code>$ cd /path/to/AndroidSDK/tools
$ ./adb devices
List of devices attached 
emulator-5554   device
</code></pre>

<p>接続が確認できたら</p>

<pre><code>$ ./adb logcat
</code></pre>

<p>これでブラウザを起動してconsole.logの出力を見たいページを表示すればコンソールに出力が流れてきます。ただし、console.log以外のもろもろのデバッグ情報もダーっと流れてくるので適当にgrepかけとくと吉。</p>

<pre><code>$ ./adb logcat | grep browser
</code></pre>

<p>次、実機で確認する方法。まず実機のほうの設定でデバッグの設定をします。端末によるのかもしれないけど、Xperia ackの場合は「設定」→「アプリケーション」→「開発」→「USBデバッグ」にチェックします。で、USBで接続するとadbで認識されるようになるはず。</p>

<pre><code>$ ./adb devices
List of devices attached 
xxxxxxxxxxxxxxx    device
</code></pre>

<p>認識されてたらさっきと同じようにlogcatすればconsole.logの出力とかがコンソールに流れてきます。こんな感じ出る。</p>

<p><img src="/img/posts/2011-05-12-12152024/3.png" alt="logcatでログが表示される様子" /></p>

<p>ちなみに接続が複数あったらadb logcatの起動がエラーになるので、以下のように指定します。</p>

<pre><code># エミュレーターの場合
$ ./adb -e logcat

# 実機の場合
$ ./adb -d logcat

# serial numberを指定して起動する場合
$ ./adb -s &lt;serial number&gt; logcat
</code></pre>

<p>-sのserial numberってのは adb deviceds したときに表示される文字列のことです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[StorageEventで勘違いしていたこと]]></title>
    <link href="http://webtech-walker.com/archive/2011/05/01212155.html"/>
    <updated>2011-05-01T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2011/05/01212155</id>
    <content type="html"><![CDATA[<p>StorageEventってlocalStorageとかsessionStorageとかでStorageの値を書き変えたときに発生するイベントってのは知ってたんだけど、前に試してみて動かなかったんで実装されてないのかなーと思って放置してた。</p>

<p>でも<a href="http://amzn.to/m2MDro">入門HTML5</a>を読んだら、localStorage実装されてたらStorageEventも実装されてるよって書いてあったから試してみたけどやっぱ動かなかったんでちゃんと調べたら、そもそも勘違いしてたことに気づいた。</p>

<p>普通に</p>

<div class="highlight"><pre><code class="javascript"><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</code></pre>
</div>

<p>ってスクリプトを書いたHTMLを開いて、コンソールとかで localStorage.setItem(’hoge’, Math.random()) とか実行して発火しなかったんで、なんだよやっぱ動かねーじゃねーかと思ったんだけど、仕様書をよく読んだらこんな表記があった。</p>

<blockquote>
  <p>When the setItem(), removeItem(), and clear() methods are called on a Storage object x that is associated with a local storage area, if the methods did something, then in every Document object whose Window object’s localStorage attribute’s Storage object is associated with the same storage area, other than x, a storage event must be fired, as described below.</p>

  <p><cite><a href="http://www.w3.org/TR/2011/CR-webstorage-20111208/#localStorageEvent">Web Storage</a></cite></p>
</blockquote>

<p>つまり、Storageを更新した場合、Storageを更新したドキュメント以外の、同じStorage領域を持ってるドキュメントでStorageEventが発火するってことみたい。</p>

<p>ウインドウを二つ開いて、コンソールでLocalStorage更新したら実行してない方のウィンドウで発火してた。こういう使い方だったのね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Chromeの等幅フォントがOsakaになってる件]]></title>
    <link href="http://webtech-walker.com/archive/2011/04/29180449.html"/>
    <updated>2011-04-29T00:00:00+09:00</updated>
    <id>http://webtech-walker.com/archive/2011/04/29180449</id>
    <content type="html"><![CDATA[<p>Chrome11で等幅フォントがOsakaになってて、全然等幅じゃなくなってた。前からだっけ？</p>

<p><img src="/img/posts/2011-04-29-29180449/1.png" alt="Chromeの設定画面で固定幅フォントがOsakaになってる" /></p>

<p>こんな感じになってた。</p>

<p><img src="/img/posts/2011-04-29-29180449/2.png" alt="コードが等幅になってない" /></p>

<p>とりあえずフォントの設定でMonacoにしといた。（なぜかOsaka-Monoがない？）</p>

<p><img src="/img/posts/2011-04-29-29180449/3.png" alt="Chromeの設定でMonacoにする" /></p>

<p>等幅になった。</p>

<p><img src="/img/posts/2011-04-29-29180449/4.png" alt="コードが等幅になる" /></p>
]]></content>
  </entry>
  
</feed>
